---
title: "Washington: Wildfire Smoke and Health Outcomes for Manuscript"
author: "Ryan Gan"
date: "October 11, 2016"
output: html_document
---

```{r setup, include=FALSE}
# loading libraries used
library(tidyverse) # import tidyverse
library(survival) # for conditional logistic regression
library(htmlTable) # table

```

## Overview

This document contains updated results for the association between wildfire smoke PM~2.5~ and cardiovascular (CVD) and respiratory health outcomes. Herein, I compare different PM~2.5~ estimation methods described in further detail below. 

Note, epidemiological methods that Sheryl and I think can improve our estimation and reduce some bias around the point estimates will not be the focus of the manuscript. 

```{r data_import, include = F, echo = FALSE}
# Set working directory and read in files --------------------------------------
# direct path for mac
#path <- paste0("/Users/ryangan/Documents/local_git_repo/wildfire_washington/",
#        "analysis/analysis_data")

# direct path for pc
path <- paste0("C:/Users/RGan/Documents/git_local_repos/wildfire/",
               "wildfire_washington/analysis/analysis_data")

# Infile case-crossover dataframes ---------------------------------------------
# Dataframes made in 'chars_3month_binary_smoke_may2016 script
# resp exacerbations
resp_casecross <- read_csv(paste(path, 
                                 "resp1_jul_to_oct_time_strat_casecross.csv", 
                                 sep = "/"))
# asthma
asthma_casecross <- read_csv(paste(path, 
                                   "asthma1_jul_to_oct_time_strat_casecross.csv", 
                                   sep = "/"))
# copd 
copd_casecross <- read_csv(paste(path, 
                                 "copd1_jul_to_oct_time_strat_casecross.csv", 
                                 sep = "/"))
# copd exacerbations
copd_ex_casecross <- read_csv(paste(path, 
                                    "copd_ex1_jul_to_oct_time_strat_casecross.csv",
                                    sep="/"))
# pneum or bronchitis
pneum_casecross <- read_csv(paste(path, 
                                  "pneum1_jul_to_oct_time_strat_casecross.csv",
                                  sep="/"))
# acute bronchitis
acute_bronch_casecross <- read_csv(paste(path, 
                                   "acute_bronch1_jul_to_oct_time_strat_casecross.csv",
                                         sep = "/"))
# cvd
cvd_casecross <- read_csv(paste(path, 
                                "cvd1_jul_to_oct_time_strat_casecross.csv",
                                sep="/"))
# arrhythmia
arrhythmia_casecross <- read_csv(paste(path, 
                                "arrhythmia1_jul_to_oct_time_strat_casecross.csv",
                                 sep="/"))
# cerebral vascular
cereb_vas_casecross <- read_csv(paste(path, 
                                "cereb_vas1_jul_to_oct_time_strat_casecross.csv",
                                sep="/"))
# heart failure
hf_casecross <- read_csv(paste(path, 
                               "hf1_jul_to_oct_time_strat_casecross.csv", 
                               sep="/"))
# ischemic heart disease
ihd_casecross <- read_csv(paste(path, 
                                "ihd1_jul_to_oct_time_strat_casecross.csv",
                                sep="/"))
# myo infarc
mi_casecross <- read_csv(paste(path, 
                               "mi1_jul_to_oct_time_strat_casecross.csv", sep="/"))
# RA
ra_casecross <- read_csv(paste(path, 
                               "ra1_jul_to_oct_time_strat_casecross.csv", sep="/"))
# broken arm
broken_arm_casecross <- read_csv(paste(path, 
                                       "broken_arm1_jul_to_oct_time_strat_casecross.csv",
                                       sep="/"))

# zip smoke pm 
#zip_pm <- read_csv(paste(path, "../smoke/zip_population_weighted_pm/zip_pm_to_merge_with_chars.csv",
#                         sep="/"))

```

## Methods Description

In these comparisons, we examine various methods of smoke/PM~2.5~ estimations and associations with health outcomes using a time-stratified case-crossover study design. Health outcomes for a patient with a primary diagnosis of cardiopulmonary health outcomes and their date of admission  (index time) were identified. We then created counterfactual observations for each patient for the same day of the week for the entire wildfire season (July 1st to Octboer 31st, 2012). We further limited our analyses to claims that were coded as emergency or urgent visits to eliminate bias from patients going in for elective/planned procedures. For patients who have a index time closer to July 1, 2012 or closer to October 31, 2012, their referent observations before or after these dates will be excluded as I will not be able to assign estimates of PM~2.5~ to these referent observations. However, this is not a big issue for a time-stratified design as other referent values throughout the time period average out.  

The **health outcomes** of interest are all respiratory, asthma, COPD, pneumonia, acute bronchitis, cardiovascular disease, heart failure, ischemic heart disease, and myocardial infarction. I also included broken arm, which I hypothesize to not be associated with wildfire smoke exposure and use as a check.

As for **exposure methods**, there are four main estimation methods for PM~2.5~: WRF-Chem Smoke (which substracts the WRF-Chem no fire emission from WRF-chem). For the WRF-Chem variable with the 'smoke' designator, this is WRF-Chem - WRF-Chem no fire. For Global Regression, Geo-Weighted Regression, and Kriging with 'smk' designator, I subtracted off the 'Background' estimates of smoke, which I believe are the monthly averages of PM~2.5~ for a given grid.

The **analytic method** is the conditional logistic regression model using the *survival* package in R. Each conditional logistic regression model accounts for the subject, and adjusts for temperature from the WRF-Chem model. The conditional logistic regression model \beta represents the change in risk of an event associated with a short-term unit increase in exposure, and can be calculated as an average difference between exposure at the index time and a weighted average of exposure at all times in the referent window. See Janes et al. 2005, **Statistics in Medicine**.

I've run a couple different scenarios for selecting referent periods, each of which has some paper that may justify the benefit of the design, relative to other methods.

## Time-Stratified Case-Crossover (referent period same day of the week within the same month)

The original time-stratified case-crossover design suggested picking referent periods based on any potential time-varying confounding, *a priori*. For example, if day of the week and the month of the exposure sequence is of concern, one might pick referents in the same day of the week and the same day of the month. The papers that discuss and support the use of a time-stratified design are the Janes et al. 2005 **Epidemiology paper**, *Case-Crossover Analyses of Air Pollution Exposure Data; Referent Selection Strategies and Their Implication for Bias*.

The authors state that with the time-stratified design, the *a priori* selection of the referent period on the same day of the week within the same month has the following benefits:

1. Localizable - Meaning that the likelihood of index times conditional on the referent windows contains information about \beta, which I think means the relative difference in the exposed vs unexposed, conditioned on the exposure (air pollution in their example), is unbiased.

2. Non-ignroable - Meaning that time-varying factors can be ignored when using a conditional logistic regression; controlled through design (matching on day of week within the same season). 

More referent periods is better for statistical efficiency, but there is a tradeoff, where additional referent periods may introduce what they call 'overlap bias', which they mathmatically define in Janes 2005 **Statistics in Medicine** paper, *Overlap Bias in the Case-Crossover Design, with Applications to Air Pollution Exposures*. Basically this bias occurs when the exposure assigned in the referent period is conditional on the strategy used to define the referent period.

As Janes et al. state in their 2005 **Statistics in Medicine** paper:
> *Two of the main strengths of the case-crossover design in the air pollution context are
that it controls fixed confounders and allows for control over time-dependent confounders
by design. Choosing referents that are restricted to the same day of the week and season
as the index time will control for these effects. Though we have not examined the degree
to which various referent selection strategies control bias due to confounding, several points
are clear. Referents that are closer to the index time will achieve greater control of seasonal
confounding. However, sampling referents closer to the index time will also result in a loss
of power due to less heterogeneity in the exposure series, and a smaller number of referents
will also result in lower power.*

I will use both Janes 2005 papers in **Epidemiology** and **Statistics in Medicine** to justify the use of the time-stratified design.

The time-dependent confounders have been what I'm struggling with, as the variation of wildfire smoke depends on a variety of factors, including season. I present a three different scenarios which can be justified in a paper: within month, within season, and within wildfire season.

This design has an advantage over other case-crossover designs I've explored in that you can use more referent times, and as the exposure at these times are averaged for each subject over a set time period, this balances out some of the more extreme values of PM~2.5~ that may persist over a couple weeks due to wildfire smoke. 

```{r time stratified design within month, echo = F, results='asis'} 
# note above, results = 'asis' needed to print htmlTables

# look up admit type, may want to subset to specifc admit
# ADM_TYPE variable: 1 = emergency, 2 = urgent, 3 = elective, 4 = newborn
# 5 = trauma, 9 = info not available

# I removed copd exacerbation and rheuamtoid arthritis

# dataframe list
df_list <- list(resp_casecross, asthma_casecross, copd_casecross, pneum_casecross,
                acute_bronch_casecross, cvd_casecross, arrhythmia_casecross,
                cereb_vas_casecross, hf_casecross, ihd_casecross, mi_casecross, 
                broken_arm_casecross)

outcome_list <- c('All Respiratory', 'Asthma', 'COPD', 'Pneumonia', 
                  'Acute Bronchitis', 'Cardiovascular Disease', 'Arrhythmia', 
                  'Cerebrovascular Disease', 'Heart Failure',
                  'Ischemic Heart Disease', 'Myocardial Infarction', 'Broken Arm')

# looking only at wrf chem, kriging, and geo-weighted; taking out 'Global Smoke' method
method_list <- c('WRF-Chem Smoke', 'Kriging Smoke', 'Global Smoke', 'Geo-Weighted Smoke')

# create an empty list to row bind dataframes together
datalist <- list()

# data wrangling ----
# Producing conditional logit model estimates loop 
for(i in 1:length(df_list)){

# dataframe to loop through
  df_to_loop <- data.frame(df_list[i])
  # indication of column
  outcome <- colnames(df_to_loop[3])
  # outcome name
  outcome_name <- outcome_list[i]

  # extract covariates from dataframe
  covariates_df <- df_to_loop[, c(1:16, 27:28, 151:155)]
  
  # extract pm values and divide by 10 and ordered
  #which(colnames(df_to_loop)=="global_smk_pm_zip") # code to find column numbers
  pm_estimates_df <- df_to_loop[, c(19, 26, 25, 24)]/10  # create 10 unit increases
  
  # dataframe for analysis creation
  # bind columns back together 
  df_analysis <- cbind(covariates_df, pm_estimates_df) %>% 
    # remove missing pm values
    filter(!is.na(wrf_smk_pm_zip)) %>% 
    # limit to emergency or urgent care
    filter(ADM_TYPE == 1 | ADM_TYPE == 2) %>%
    # the following code makes sure that the counterfactual values retained are 
    # symetric in that number of obs before = number of obs after
    mutate(obs_diff_admission = (date - date_admit)/7) %>% 
      group_by(PATIENTID) %>% 
      # identifies the min and max observations, and sets it to the minimum n of obs
      mutate(min_obs_diff = abs(min(obs_diff_admission)),
             max_obs_diff = abs(max(obs_diff_admission)),
             obs_limit = min(c(min_obs_diff, max_obs_diff)),
             keep_obs = ifelse(month_admit == month_smk, 1, 0))%>% 
      filter(keep_obs == 1)

  # empty df for table
  table_df <- data.frame()
  
  # empty matrix
  point_estimates <- matrix(nrow = 4, ncol = 9, byrow = T)
  
  colnames(point_estimates) <- c('outcome', 'pm_method', 'n', 'n_events', 'odds_ratio', 
                                 'lower95', 'upper95', 'se', 'p_val')
  
  # fill in the outcome name for the dataframe before the loop
  point_estimates[, 1] <- outcome_name

  # second loop to run a model for each pm estimation method
    for(j in 24:27){

      # variable to model 
      var_name <- colnames(df_analysis[j])

      # conditional logistic regression model
      mod <- clogit(outcome ~ df_analysis[[j]] + wrf_temp_zip +
                    strata(PATIENTID), df_analysis)
      
      # populate matrix
      row_n <- j-23
      
      point_estimates[row_n, 2] <- method_list[row_n]
      point_estimates[row_n, 3] <- mod$n
      point_estimates[row_n, 4] <- mod$nevent
      # odds ratio
      point_estimates[row_n, 5] <- round(exp(summary(mod)$coefficient[1,1]), 3)

      # 95% lower bound
      point_estimates[row_n, 6] <- round(exp((summary(mod)$coefficient[1,1]) -
                                        1.96*(summary(mod)$coefficient[1,3])), 3)
      # 95% upper bound
      point_estimates[row_n, 7] <- round(exp((summary(mod)$coefficient[1,1]) +
                                        1.96*(summary(mod)$coefficient[1,3])), 3)
      # standard error
      point_estimates[row_n, 8] <- round(summary(mod)$coefficient[1,3], 4)
      # p val
      point_estimates[row_n, 9] <- round(summary(mod)$coefficient[1,5], 4)
  
      # save point estimates as a dataframe
      point_est_df <- as_data_frame(point_estimates)

    }
  
# combine previous values in dataframe that has all outcome/methods comparisons
datalist[[i]] <- point_est_df

} # end of loop

# combine each outcome dataframe itteration in to a big dataset
combined_point_est_df <- bind_rows(datalist)


# subset columns I want to put in to the table
table_df <- combined_point_est_df %>% select(2, 3:7) 


  tab <- htmlTable(txtRound(table_df, digits = 3, 1:3), 
           caption = "Association Between a 10 ug/m^3 in PM2.5 and Health Outcomes",
           # row group by outcome
           rgroup = outcome_list,
           n.rgroup = c(rep(4, 12)), # 4 rows for each method for each outcome
           # column headers
           header = c("Method", "Obs.", "Events",
                      "OR&dagger;", "Lower", "Upper"),
           # column spanner
           cgroup = c("", "95% CI"), 
           n.cgroup = c(4, 2),
           padding.rgroup = "&nbsp;&nbsp;",
           css.cell = "padding-left: 0.5em; padding-right: .5em;", # cell space
           align = "llccccc", # column alignment,
           tfoot="&dagger; Adjusted for temperature, accounting for subject. Time-stratified: referent periods matched to events on same day of week within the same month."
            ) # end table
  
  print(tab)
  
# ggplot of odds ratios, facet wrapped by outcomes -----
# convert variables from character to either numeric or factor
# factor preserves the order of the variable
combined_point_est_df$outcome <- factor(combined_point_est_df$outcome, 
                                        levels = unique(combined_point_est_df$outcome))

combined_point_est_df$pm_method <- factor(combined_point_est_df$pm_method, 
                                          levels = unique(combined_point_est_df$pm_method))

combined_point_est_df$n <- as.numeric(combined_point_est_df$n)
combined_point_est_df$n_events <- as.numeric(combined_point_est_df$n_events)
combined_point_est_df$odds_ratio <- as.numeric(combined_point_est_df$odds_ratio)
combined_point_est_df$lower95 <- as.numeric(combined_point_est_df$lower95)
combined_point_est_df$upper95 <- as.numeric(combined_point_est_df$upper95)
combined_point_est_df$se <- as.numeric(combined_point_est_df$se)
combined_point_est_df$p_val <- as.numeric(combined_point_est_df$p_val)

## ggplot
  print_plot <- ggplot(combined_point_est_df, 
                       aes(x = pm_method, y = odds_ratio, colour = pm_method)) +
    geom_point() + #geom_text(vjust = 0, nudge_x = 0.3) +
    geom_errorbar(aes(ymin=lower95, ymax=upper95), width = 0.2) +
    facet_wrap(~outcome, nrow = 3) +
    geom_hline(yintercept = 1, linetype=2) +
    ggtitle('Association Between PM2.5 from \n Wildfire Smoke on Hospitalizations') +
    ylab('Odds Ratio for 10µg/m^3 Increase in PM2.5') +
    xlab('Time-Stratified Referent Period Within Month') +
    scale_colour_discrete(name= "Smoke Method") +
    theme(panel.background = element_rect(fill = 'white', colour = 'black'),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.title.y = element_text(angle = 90),
    axis.text.x = element_blank(),
    axis.title.y = element_text(angle = 90),
    # facet text size
    strip.text = element_text(size = 7),
    legend.text = element_text(size = 7)) 

  print(print_plot)

```

### Result Summary: Time-Stratified Case-Crossover Design (same day of week within the month)

With this method, the only significant result is with WRF-Chem smoke and asthma.There might be some marginally significant results, however I think the major issue is it's power challenged. More importnatly, exposure series of wildfire smoke is very difficult to define referent period. Although this time-stratified referent of same week days within the month strategy may work well for air pollution, I think a problem persists with the extreme variability in PM~2.5~ due to smoke, where this short time window may still pick up high smoke days when the subject is not necissarily at risk. The major goal is to accounty for time-varying confounding, such as season. So perhaps a referent strategy for the time-stratified design is same days within the week, within the wildfire season (or perhaps the season of spring, summer, fall). I think a good arguement could be made for this.

## Time-Stratified Case-Crossover (referents same day of week within summer or fall season)

This variation selects referent periods on the same day as the index date of the case, within the same season (summer or fall). Benefit to this over just month is it provides more referent periods to average, which likely 'smooths' out any major bumps in the PM~2.5~ distribution due to some of the extreme variablity of wildfire smoke PM~2.5~ that may occur either before or after the index day.

```{r time stratified design within season, echo = F, results='asis'} 
# note above, results = 'asis' needed to print htmlTables


# I removed copd exacerbation and rheuamtoid arthritis

# dataframe list
df_list <- list(resp_casecross, asthma_casecross, copd_casecross, pneum_casecross,
                acute_bronch_casecross, cvd_casecross, arrhythmia_casecross,
                cereb_vas_casecross, hf_casecross, ihd_casecross, mi_casecross, 
                broken_arm_casecross)

outcome_list <- c('All Respiratory', 'Asthma', 'COPD', 'Pneumonia', 
                  'Acute Bronchitis', 'Cardiovascular Disease', 'Arrhythmia', 
                  'Cerebrovascular Disease', 'Heart Failure',
                  'Ischemic Heart Disease', 'Myocardial Infarction', 'Broken Arm')

# looking only at wrf chem, kriging, and geo-weighted; taking out 'Global Smoke' method
method_list <- c('WRF-Chem Smoke', 'Kriging Smoke', 'Global Smoke', 'Geo-Weighted Smoke')

# create an empty list to row bind dataframes together
datalist <- list()

# data wrangling ----
# Producing conditional logit model estimates loop 
for(i in 1:length(df_list)){

# dataframe to loop through
  df_to_loop <- data.frame(df_list[i])
  # indication of column
  outcome <- colnames(df_to_loop[3])
  # outcome name
  outcome_name <- outcome_list[i]

 

  # extract covariates from dataframe
  covariates_df <- df_to_loop[, c(1:16, 27:28, 151:157)]
  
  # extract pm values and divide by 10 and ordered
  #which(colnames(df_to_loop)=="global_smk_pm_zip") # code to find column numbers
  pm_estimates_df <- df_to_loop[, c(19, 26, 25, 24)]/10  # create 10 unit increases
  
  # dataframe for analysis creation
  # bind columns back together 
  df_analysis <- cbind(covariates_df, pm_estimates_df) %>% 
    # remove missing pm values
    filter(!is.na(wrf_smk_pm_zip)) %>% 
    # limit to emergency or urgent care
    filter(ADM_TYPE == 1 | ADM_TYPE == 2) %>%
    # the following code makes sure that the counterfactual values retained are 
    # symetric in that number of obs before = number of obs after
    mutate(obs_diff_admission = (date - date_admit)/7) %>% 
    # referents limited to same season
    group_by(PATIENTID) %>% 
    # identifies the min and max observations, and sets it to the minimum n of obs
    mutate(min_obs_diff = abs(min(obs_diff_admission)),
           max_obs_diff = abs(max(obs_diff_admission)),
           obs_limit = min(c(min_obs_diff, max_obs_diff)),
           keep_obs = ifelse(season_admit == season_smk, 1, 0))%>% 
    filter(keep_obs == 1)
  
  # empty df for table
  table_df <- data.frame()
  
  # empty matrix
  point_estimates <- matrix(nrow = 4, ncol = 9, byrow = T)
  
  colnames(point_estimates) <- c('outcome', 'pm_method', 'n', 'n_events', 'odds_ratio', 
                                 'lower95', 'upper95', 'se', 'p_val')
  
  # fill in the outcome name for the dataframe before the loop
  point_estimates[, 1] <- outcome_name


  # second loop to run a model for each pm estimation method
    for(j in 26:29){

      # variable to model 
      var_name <- colnames(df_analysis[j])

      # conditional logistic regression model
      mod <- clogit(outcome ~ df_analysis[[j]] + wrf_temp_zip +
                    strata(PATIENTID), df_analysis)
      
      # populate matrix
      row_n <- j-25
      
      point_estimates[row_n, 2] <- method_list[row_n]
      point_estimates[row_n, 3] <- mod$n
      point_estimates[row_n, 4] <- mod$nevent
      # odds ratio
      point_estimates[row_n, 5] <- round(exp(summary(mod)$coefficient[1,1]), 3)

      # 95% lower bound
      point_estimates[row_n, 6] <- round(exp((summary(mod)$coefficient[1,1]) -
                                        1.96*(summary(mod)$coefficient[1,3])), 3)
      # 95% upper bound
      point_estimates[row_n, 7] <- round(exp((summary(mod)$coefficient[1,1]) +
                                        1.96*(summary(mod)$coefficient[1,3])), 3)
      # standard error
      point_estimates[row_n, 8] <- round(summary(mod)$coefficient[1,3], 4)
      # p val
      point_estimates[row_n, 9] <- round(summary(mod)$coefficient[1,5], 4)
  
      # save point estimates as a dataframe
      point_est_df <- as_data_frame(point_estimates)

    }
  
# combine previous values in dataframe that has all outcome/methods comparisons
datalist[[i]] <- point_est_df

} # end of loop

# combine each outcome dataframe itteration in to a big dataset
combined_point_est_df <- bind_rows(datalist)


# subset columns I want to put in to the table
table_df <- combined_point_est_df %>% select(2, 3:7) 


  tab <- htmlTable(txtRound(table_df, digits = 3, 1:3), 
           caption = "Association between a 10 ug/m^3 in PM2.5 and Health Outcomes",
           # row group by outcome
           rgroup = outcome_list,
           n.rgroup = c(rep(4, 12)), # 4 rows for each method for each outcome
           # column headers
           header = c("Method", "Obs.", "Events",
                      "OR&dagger;", "Lower", "Upper"),
           # column spanner
           cgroup = c("", "95% CI"), 
           n.cgroup = c(4, 2),
           padding.rgroup = "&nbsp;&nbsp;",
           css.cell = "padding-left: 0.5em; padding-right: .5em;", # cell space
           align = "llccccc", # column alignment,
           tfoot="&dagger; Adjusted for temperature, accounting for subject. Time-stratified: referent periods matched to events on same day of week within season."
            ) # end table
  
  print(tab)
  
# ggplot of odds ratios, facet wrapped by outcomes -----
# convert variables from character to either numeric or factor
# factor preserves the order of the variable
combined_point_est_df$outcome <- factor(combined_point_est_df$outcome, 
                                        levels = unique(combined_point_est_df$outcome))

combined_point_est_df$pm_method <- factor(combined_point_est_df$pm_method, 
                                          levels = unique(combined_point_est_df$pm_method))

combined_point_est_df$n <- as.numeric(combined_point_est_df$n)
combined_point_est_df$n_events <- as.numeric(combined_point_est_df$n_events)
combined_point_est_df$odds_ratio <- as.numeric(combined_point_est_df$odds_ratio)
combined_point_est_df$lower95 <- as.numeric(combined_point_est_df$lower95)
combined_point_est_df$upper95 <- as.numeric(combined_point_est_df$upper95)
combined_point_est_df$se <- as.numeric(combined_point_est_df$se)
combined_point_est_df$p_val <- as.numeric(combined_point_est_df$p_val)

## ggplot
  print_plot <- ggplot(combined_point_est_df, 
                       aes(x = pm_method, y = odds_ratio, colour = pm_method)) +
    geom_point() + #geom_text(vjust = 0, nudge_x = 0.3) +
    geom_errorbar(aes(ymin=lower95, ymax=upper95), width = 0.2) +
    facet_wrap(~outcome, nrow = 3) +
    geom_hline(yintercept = 1, linetype=2) +
    ggtitle('Association Between PM2.5 from \n Wildfire Smoke on Hospitalizations') +
    ylab('Odds Ratio for 10µg/m^3 Increase in PM2.5') +
    xlab('Time-Stratified Within Season') +
    scale_colour_discrete(name= "Smoke Method") +
    theme(panel.background = element_rect(fill = 'white', colour = 'black'),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.title.y = element_text(angle = 90),
    axis.text.x = element_blank(),
    axis.title.y = element_text(angle = 90),
    # facet text size
    strip.text = element_text(size = 7),
    legend.text = element_text(size = 7)) 

  print(print_plot)

```

### Result Summary: Time-Stratified Case-Crossover Design (same day of week within the season)

For these results, we see that all exposure methods are significantly associated with an increase in all respiratory outcomes and asthma. The WRF-Chem smoke method is associated with cerebrovascular disease as well. As for the other models, Kriging, Global Regression, and Geo-Weighted Regression, those are associated with COPD. 

A general interpretation is as follows:
A 10 \mu g/m^3^ increase in PM~2.5~ attributed to wildfire smoke was associated with a X% increase in the risk for a health event. Where X% is the odds ratio - 1 (e.g. OR of 1.20 - 1 = 20% increase). 
Note that the odds ratio approximates the relative risk in this case due to the rare outcome assumption in that the calcuation for an odds ratio is similar to risk ratio calcuation.

## Time-Stratified Case-Crossover (referents same day of week within fire season July - October)

Similar to the last seasonal example, this time-stratified referent strategy allows even more referent observations to average to 'smooth' out some of those extreme PM~2.5~ concentrations in some referent periods.

```{r time stratified design within fire season, echo = F, results='asis'} 
# note above, results = 'asis' needed to print htmlTables


# I removed copd exacerbation and rheuamtoid arthritis

# dataframe list
df_list <- list(resp_casecross, asthma_casecross, copd_casecross, pneum_casecross,
                acute_bronch_casecross, cvd_casecross, arrhythmia_casecross,
                cereb_vas_casecross, hf_casecross, ihd_casecross, mi_casecross, 
                broken_arm_casecross)

outcome_list <- c('All Respiratory', 'Asthma', 'COPD', 'Pneumonia', 
                  'Acute Bronchitis', 'Cardiovascular Disease', 'Arrhythmia', 
                  'Cerebrovascular Disease', 'Heart Failure',
                  'Ischemic Heart Disease', 'Myocardial Infarction', 'Broken Arm')

# looking only at wrf chem, kriging, and geo-weighted; taking out 'Global Smoke' method
method_list <- c('WRF-Chem Smoke', 'Kriging Smoke', 'Global Smoke', 'Geo-Weighted Smoke')

# create an empty list to row bind dataframes together
datalist <- list()

# data wrangling ----
# Producing conditional logit model estimates loop 
for(i in 1:length(df_list)){

# dataframe to loop through
  df_to_loop <- data.frame(df_list[i])
  # indication of column
  outcome <- colnames(df_to_loop[3])
  # outcome name
  outcome_name <- outcome_list[i]

 

  # extract covariates from dataframe
  covariates_df <- df_to_loop[, c(1:16, 27:28, 151:157)]
  
  # extract pm values and divide by 10 and ordered
  #which(colnames(df_to_loop)=="global_smk_pm_zip") # code to find column numbers
  pm_estimates_df <- df_to_loop[, c(19, 26, 25, 24)]/10  # create 10 unit increases
  
  # dataframe for analysis creation
  # bind columns back together 
  df_analysis <- cbind(covariates_df, pm_estimates_df) %>% 
    # remove missing pm values
    filter(!is.na(wrf_smk_pm_zip)) %>% 
    # limit to emergency or urgent care
    filter(ADM_TYPE == 1 | ADM_TYPE == 2) %>%
    # the following code makes sure that the counterfactual values retained are 
    # symetric in that number of obs before = number of obs after
    mutate(obs_diff_admission = (date - date_admit)/7) 
    # dataframe is already for the entire fire season, so I don't need to subset anymore
  
  # empty df for table
  table_df <- data.frame()
  
  # empty matrix
  point_estimates <- matrix(nrow = 4, ncol = 9, byrow = T)
  
  colnames(point_estimates) <- c('outcome', 'pm_method', 'n', 'n_events', 'odds_ratio', 
                                 'lower95', 'upper95', 'se', 'p_val')
  
  # fill in the outcome name for the dataframe before the loop
  point_estimates[, 1] <- outcome_name


  # second loop to run a model for each pm estimation method
    for(j in 26:29){

      # variable to model 
      var_name <- colnames(df_analysis[j])

      # conditional logistic regression model
      mod <- clogit(outcome ~ df_analysis[[j]] + wrf_temp_zip +
                    strata(PATIENTID), df_analysis)
      
      # populate matrix
      row_n <- j-25
      
      point_estimates[row_n, 2] <- method_list[row_n]
      point_estimates[row_n, 3] <- mod$n
      point_estimates[row_n, 4] <- mod$nevent
      # odds ratio
      point_estimates[row_n, 5] <- round(exp(summary(mod)$coefficient[1,1]), 3)

      # 95% lower bound
      point_estimates[row_n, 6] <- round(exp((summary(mod)$coefficient[1,1]) -
                                        1.96*(summary(mod)$coefficient[1,3])), 3)
      # 95% upper bound
      point_estimates[row_n, 7] <- round(exp((summary(mod)$coefficient[1,1]) +
                                        1.96*(summary(mod)$coefficient[1,3])), 3)
      # standard error
      point_estimates[row_n, 8] <- round(summary(mod)$coefficient[1,3], 4)
      # p val
      point_estimates[row_n, 9] <- round(summary(mod)$coefficient[1,5], 4)
  
      # save point estimates as a dataframe
      point_est_df <- as_data_frame(point_estimates)

    }
  
# combine previous values in dataframe that has all outcome/methods comparisons
datalist[[i]] <- point_est_df

} # end of loop

# combine each outcome dataframe itteration in to a big dataset
combined_point_est_df <- bind_rows(datalist)


# subset columns I want to put in to the table
table_df <- combined_point_est_df %>% select(2, 3:7) 


  tab <- htmlTable(txtRound(table_df, digits = 3, 1:3), 
           caption = "Association between a 10 ug/m^3 in PM2.5 and Health Outcomes",
           # row group by outcome
           rgroup = outcome_list,
           n.rgroup = c(rep(4, 12)), # 4 rows for each method for each outcome
           # column headers
           header = c("Method", "Obs.", "Events",
                      "OR&dagger;", "Lower", "Upper"),
           # column spanner
           cgroup = c("", "95% CI"), 
           n.cgroup = c(4, 2),
           padding.rgroup = "&nbsp;&nbsp;",
           css.cell = "padding-left: 0.5em; padding-right: .5em;", # cell space
           align = "llccccc", # column alignment,
           tfoot="&dagger; Adjusted for temperature, accounting for subject. Time-stratified: referent periods matched to events on same day of week within July to October fire season."
            ) # end table
  
  print(tab)
  
# ggplot of odds ratios, facet wrapped by outcomes -----
# convert variables from character to either numeric or factor
# factor preserves the order of the variable
combined_point_est_df$outcome <- factor(combined_point_est_df$outcome, 
                                        levels = unique(combined_point_est_df$outcome))

combined_point_est_df$pm_method <- factor(combined_point_est_df$pm_method, 
                                          levels = unique(combined_point_est_df$pm_method))

combined_point_est_df$n <- as.numeric(combined_point_est_df$n)
combined_point_est_df$n_events <- as.numeric(combined_point_est_df$n_events)
combined_point_est_df$odds_ratio <- as.numeric(combined_point_est_df$odds_ratio)
combined_point_est_df$lower95 <- as.numeric(combined_point_est_df$lower95)
combined_point_est_df$upper95 <- as.numeric(combined_point_est_df$upper95)
combined_point_est_df$se <- as.numeric(combined_point_est_df$se)
combined_point_est_df$p_val <- as.numeric(combined_point_est_df$p_val)

## ggplot
  print_plot <- ggplot(combined_point_est_df, 
                       aes(x = pm_method, y = odds_ratio, colour = pm_method)) +
    geom_point() + #geom_text(vjust = 0, nudge_x = 0.3) +
    geom_errorbar(aes(ymin=lower95, ymax=upper95), width = 0.2) +
    facet_wrap(~outcome, nrow = 3) +
    geom_hline(yintercept = 1, linetype=2) +
    ggtitle('Association Between PM2.5 from \n Wildfire Smoke on Hospitalizations') +
    ylab('Odds Ratio for 10µg/m^3 Increase in PM2.5') +
    xlab('Time-Stratified Within July to October Fire Season') +
    scale_colour_discrete(name= "Smoke Method") +
    theme(panel.background = element_rect(fill = 'white', colour = 'black'),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.title.y = element_text(angle = 90),
    axis.text.x = element_blank(),
    axis.title.y = element_text(angle = 90),
    # facet text size
    strip.text = element_text(size = 7),
    legend.text = element_text(size = 7)) 

  print(print_plot)

```

### Result Summary: Time-Stratified Case-Crossover Design (same day of week within the season)

Like the results within season, these results within the entire wildfire season were more or less the same. We see that all exposure methods are significantly associated with an increase in all respiratory outcomes and asthma. The WRF-Chem smoke method is associated with cerebrovascular disease as well. As for the other models, Kriging, Global Regression, and Geo-Weighted Regression, those are associated with COPD. I believe this is the most justifiable design approach that would average any extreme values of PM~2.5~ across the wildfire season for the vector of referent values for a particular subject.

## Overall Summary of Time-Stratified Results

In some of my other documents, I tried different referent selection schemes for the case-crossover design, specifically the symmetric bi-directional design, where referent periods were matched to the same day of the week. In some cases, this produced similar estimates to the time-stratified results within season and wildfire season presented herein. However, as demonstrated in the Janes 2005 **Statistics in Medicine** paper, the symmetric bi-directional still has a bias in that the \beta is not necissarily unbiased, and can be a slight overestimation (which is evident in these results compared to some of my other results using that design). 



#### To do
1. Appropriately defining the referent period is important before we can publish this.
2. Try a time-series study to see if we can produce results that converge between the two designs.
